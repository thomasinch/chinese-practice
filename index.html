<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chinese Practice Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, textarea, button, select { margin: 5px 0; width: 100%; padding: 8px; box-sizing: border-box; }
    #transcript { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; }
    #controls { margin-bottom: 15px; }
  </style>
</head>
<body>
  <div id="controls">
    <input id="apiKey" type="password" placeholder="OpenAI API Key" />
    <textarea id="scenario" rows="2" placeholder="Enter practice scenario"></textarea>
    <select id="mode">
      <option value="text">Text Only</option>
      <option value="voice">Voice Only</option>
    </select>
    <button id="goBtn">Go</button>
  </div>

  <div id="transcript" readonly></div>
  <textarea id="userInput" rows="2" placeholder="Type your response..." style="display:none;"></textarea>
  <button id="sendBtn" style="display:none;">Send</button>

  <audio id="audioOut" autoplay style="display:none;"></audio>

  <script>
    let pc, dc, audioTrack;
    let running = false;

    const goBtn = document.getElementById('goBtn');
    const apiKeyInput = document.getElementById('apiKey');
    const scenarioInput = document.getElementById('scenario');
    const transcriptDiv = document.getElementById('transcript');
    const modeSelect = document.getElementById('mode');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const audioOut = document.getElementById('audioOut');

    function log(msg, obj) {
      console.log(msg, obj || '');
    }

    async function startSession() {
      const apiKey = apiKeyInput.value.trim();
      const scenario = scenarioInput.value.trim();
      const mode = modeSelect.value;
      if (!apiKey || !scenario) return alert('Provide API key and scenario');

      log('Initializing RTCPeerConnection');
      pc = new RTCPeerConnection();
      dc = pc.createDataChannel('oai-events');

      dc.onmessage = (e) => handleServerEvent(JSON.parse(e.data));
      dc.onopen = () => log('Data channel open');

      pc.ontrack = e => {
        log('Received audio track', e);
        audioOut.srcObject = e.streams[0];
      };

      if (mode === 'voice') {
        const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioTrack = ms.getTracks()[0];
        pc.addTrack(audioTrack, ms);
      }

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      log('Local description set', offer);

      const url = 'https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17';
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + apiKey,
          'Content-Type': 'application/sdp'
        },
        body: offer.sdp
      });
      const answerSdp = await resp.text();
      await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
      log('Remote description set');

      // Session update with system prompt
      const sysInstructions = `You are a friendly Chinese teacher named 小王. Speak slowly. Hold conversational practice with the learner:
- Speak mostly Mandarin Chinese, sprinkling English only when necessary for comprehension.
- Subtly correct grammar, vocabulary and pronunciation after each learner utterance.
- Steer conversation toward previously learned grammar and vocab.
- If the learner says "word是什么？", give the English meaning.
- If learner asks about a grammar structure, explain briefly in English followed by a Chinese example.
- Begin now with the scenario the learner provided.`;
      sendEvent({ type: 'session.update', session: { instructions: sysInstructions + '\nScenario: ' + scenario, } });
      sendEvent({ type: 'conversation.item.create', item: { type: 'message', role: 'user', content: [{ type: 'input_text', text: scenario }] } });
      sendEvent({ type: 'response.create', response: { modalities: [ mode === 'text' ? 'text' : 'text', ...(mode === 'voice' ? ['audio'] : []) ] } });

      transcriptDiv.innerHTML = '';
      if (mode === 'text') {
        userInput.style.display = 'block';
        sendBtn.style.display = 'block';
      }
      if (mode === 'voice') audioOut.style.display = 'block';
    }

    function stopSession() {
      log('Stopping session');
      if (audioTrack) audioTrack.stop();
      if (pc) pc.close();
      pc = null;
      dc = null;
      userInput.style.display = 'none';
      sendBtn.style.display = 'none';
      audioOut.style.display = 'none';
    }

    function sendEvent(evt) {
      evt.event_id = 'evt_' + Date.now();
      console.log('Sending event', evt);
      dc.send(JSON.stringify(evt));
    }

    function handleServerEvent(event) {
      console.log('Event from server', event);
      switch(event.type) {
        case 'response.text.delta':
          transcriptDiv.innerHTML += `<div><strong>Teacher:</strong> ${event.delta}</div>`;
          break;
        case 'response.done':
          const text = event.response.output[0].text || '';
          transcriptDiv.innerHTML += `<div><strong>Teacher:</strong> ${text}</div>`;
          break;
        // handle other events as needed
      }
      transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
    }

    goBtn.onclick = () => {
      if (!running) {
        running = true;
        goBtn.textContent = 'Stop';
        startSession();
      } else {
        running = false;
        goBtn.textContent = 'Go';
        stopSession();
      }
    };

    sendBtn.onclick = () => {
      const txt = userInput.value.trim();
      if (!txt) return;
      transcriptDiv.innerHTML += `<div><strong>You:</strong> ${txt}</div>`;
      sendEvent({ type: 'conversation.item.create', item: { type: 'message', role: 'user', content: [{ type: 'input_text', text: txt }] } });
      sendEvent({ type: 'response.create', response: { modalities: ['text'] } });
      userInput.value = '';
      transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
    };
  </script>
</body>
</html>
