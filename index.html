<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chinese Practice Tool</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #transcript { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; margin-top: 10px; }
    input, textarea, select { width: 100%; margin-top: 5px; padding: 8px; box-sizing: border-box; }
    button { margin-top: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>Chinese Practice Tool</h1>
  <label>OpenAI API Key:</label>
  <input id="apiKey" type="password" placeholder="sk-..." />

  <label>Practice Scenario:</label>
  <textarea id="scenario" rows="3" placeholder="Describe your situation..."></textarea>

  <label>Mode:</label>
  <select id="mode">
    <option value="both">Speech & Text</option>
    <option value="text">Text Only</option>
    <option value="speech">Speech Only</option>
  </select>

  <button id="startBtn">Go</button>

  <div id="transcript" placeholder="Conversation will appear here..."></div>
  <audio id="audio" autoplay></audio>

  <script>
    let pc, dc;

    document.getElementById('startBtn').addEventListener('click', startSession);

    async function startSession() {
      const apiKey = document.getElementById('apiKey').value;
      const scenario = document.getElementById('scenario').value;
      const mode = document.getElementById('mode').value;
      console.log('Starting session with mode:', mode);

      // 1. Create ephemeral key
      console.log('Fetching ephemeral key...');
      const sessRes = await fetch('https://api.openai.com/v1/realtime/sessions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ model: 'gpt-4o-realtime-preview-2024-12-17', voice: 'verse' })
      });
      const sessData = await sessRes.json();
      console.log('Ephemeral session data:', sessData);
      const token = sessData.client_secret.value;

      // 2. Setup WebRTC peer connection
      pc = new RTCPeerConnection();

      // 3. Remote audio track
      const audioEl = document.getElementById('audio');
      pc.ontrack = e => {
        console.log('Received remote track', e);
        audioEl.srcObject = e.streams[0];
      };

      // 4. Local mic
      const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      console.log('Local audio track added');

      // 5. Data channel for events
      dc = pc.createDataChannel('oai-events');
      dc.onopen = () => onDataChannelOpen(scenario, mode);
      dc.onmessage = e => handleEvent(JSON.parse(e.data));
      console.log('Data channel created');

      // 6. Create and send offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      console.log('Local SDP offer set');

      // 7. Send offer to OpenAI
      const sdpRes = await fetch(`https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/sdp'
        },
        body: offer.sdp
      });
      const answerSdp = await sdpRes.text();
      console.log('Received SDP answer');
      await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
    }

    function onDataChannelOpen(scenario, mode) {
      console.log('Data channel open, initializing session...');
      // Send session instructions
      const instructions = `You are a Chinese teacher. Role-play in Chinese, correcting grammar, vocabulary, pronunciation. Speak mostly Chinese, but use English when needed. Subtly steer the student to use learned structures.`;
      sendEvent({ type: 'session.update', session: { instructions } });

      // Send the user scenario
      sendEvent({
        type: 'conversation.item.create',
        item: {
          type: 'message',
          role: 'user',
          content: [ { type: 'input_text', text: scenario } ]
        }
      });

      // Start the response
      let modalities;
      if (mode === 'text') modalities = ['text'];
      else if (mode === 'speech') modalities = ['audio'];
      else modalities = ['audio', 'text'];
      sendEvent({ type: 'response.create', response: { modalities } });
    }

    function sendEvent(event) {
      console.log('Sending event:', event);
      dc.send(JSON.stringify(event));
    }

    function handleEvent(event) {
      console.log('Received event:', event);
      // Append text deltas to transcript
      if (event.type === 'response.text.delta') {
        document.getElementById('transcript').textContent += event.delta;
      }
      // Optionally handle other event types
      if (event.type === 'response.done') {
        console.log('Response completed');
      }
    }
  </script>
</body>
</html>
